stages:
  - test
  - build

variables:
  MYSQL_ROOT_PASSWORD: password
  MYSQL_DATABASE: testing

# Backend Test Job
test:
  stage: test
  image: php:8.2-cli
  services:
    - mysql:8.0
  variables:
    DB_CONNECTION: mysql
    DB_HOST: mysql
    DB_PORT: 3306
    DB_DATABASE: testing
    DB_USERNAME: root
    DB_PASSWORD: password
  before_script:
    - apt-get update && apt-get install -y git unzip libzip-dev libpng-dev
    - docker-php-ext-install pdo pdo_mysql bcmath zip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - cd backend
    - composer install --prefer-dist --no-interaction --no-progress
    - cp .env.example .env
    - php artisan key:generate
  script:
    - cd backend
    - php artisan migrate --force
    - php artisan test
    - ./vendor/bin/pint --test || true
  cache:
    paths:
      - backend/vendor/

# Frontend Build Job
build-frontend:
  stage: build
  image: node:20
  needs: ["test"]
  before_script:
    - cd frontend  # ถ้า frontend อยู่ใน repo เดียวกัน
    - npm ci
  script:
    - npm run build
    - npx tsc --noEmit || true
  cache:
    paths:
      - frontend/node_modules/
  # artifacts:  # ถ้าต้องการเก็บ build output
  #   paths:
  #     - frontend/dist/