# ===================================================================
# GitLab CI/CD Pipeline for IT Support Pro Backend (Laravel)
# ===================================================================
# Pipeline นี้จะรันอัตโนมัติทุกครั้งที่ push code หรือ merge request
# ประกอบด้วย 4 stages: test, analyze, build, deploy

stages:
  - test       # ทดสอบ unit tests
  - analyze    # ตรวจสอบคุณภาพ code
  - build      # build Docker image
  - deploy     # deploy ขึ้น server

# ===================================================================
# GLOBAL VARIABLES
# ===================================================================
variables:
  MYSQL_ROOT_PASSWORD: password
  MYSQL_DATABASE: testing
  MYSQL_USER: sail
  MYSQL_PASSWORD: password
  # Docker image settings
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  DOCKER_IMAGE_LATEST: $CI_REGISTRY_IMAGE:latest

# ===================================================================
# CACHE CONFIGURATION
# ===================================================================
# Cache composer dependencies เพื่อลดเวลา install
.composer-cache: &composer-cache
  cache:
    key: composer-$CI_COMMIT_REF_SLUG
    paths:
      - backend/vendor/
    policy: pull-push

# ===================================================================
# STAGE 1: TEST - ทดสอบ Unit Tests และ Feature Tests
# ===================================================================
test:
  stage: test
  image: php:8.2-cli
  <<: *composer-cache
  
  # เริ่ม MySQL service สำหรับ testing
  services:
    - name: mysql:8.0
      alias: mysql
      command:
        - --default-authentication-plugin=mysql_native_password
  
  # Environment variables สำหรับ Laravel
  variables:
    DB_CONNECTION: mysql
    DB_HOST: mysql
    DB_PORT: 3306
    DB_DATABASE: testing
    DB_USERNAME: root
    DB_PASSWORD: password
    APP_ENV: testing
    CACHE_DRIVER: array
    SESSION_DRIVER: array
    QUEUE_CONNECTION: sync
  
  before_script:
    # ติดตั้ง system dependencies
    - apt-get update && apt-get install -y git unzip libzip-dev libpng-dev
    
    # ติดตั้ง PHP extensions ที่จำเป็น
    - docker-php-ext-install pdo pdo_mysql bcmath zip gd
    
    # ติดตั้ง Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    
    # เข้าไปใน backend directory
    - cd backend
    
    # ติดตั้ง dependencies
    - composer install --prefer-dist --no-interaction --no-progress --optimize-autoloader
    
    # ตั้งค่า Laravel
    - cp .env.example .env
    - php artisan key:generate
    
    # รอให้ MySQL พร้อม
    - |
      for i in $(seq 1 30); do
        php -r "try { new PDO('mysql:host=mysql;dbname=testing', 'root', 'password'); echo 'MySQL is ready!'; exit(0); } catch (Exception \$e) { echo 'Waiting for MySQL...'; sleep(2); }"
      done
  
  script:
    - cd backend
    # รัน migrations
    - php artisan migrate --force
    
    # รัน tests พร้อม coverage report
    - php artisan test --coverage-text
  
  # เก็บ test results
  artifacts:
    when: always
    reports:
      junit: backend/storage/logs/junit.xml
    paths:
      - backend/storage/logs/
    expire_in: 7 days
  
  # รันเฉพาะ branches หลัก
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

# ===================================================================
# STAGE 2: ANALYZE - ตรวจสอบคุณภาพ Code
# ===================================================================

# Laravel Pint - Code Style Checker
code-style:
  stage: analyze
  image: php:8.2-cli
  <<: *composer-cache
  
  before_script:
    - apt-get update && apt-get install -y git unzip libzip-dev
    - docker-php-ext-install zip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - cd backend
    - composer install --prefer-dist --no-interaction --no-progress
  
  script:
    - cd backend
    # ตรวจสอบ code style ด้วย Pint
    - ./vendor/bin/pint --test
  
  allow_failure: true  # ไม่ให้ pipeline fail ถ้า style ไม่ผ่าน
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# PHPStan - Static Analysis (Optional)
# static-analysis:
#   stage: analyze
#   image: php:8.2-cli
#   <<: *composer-cache
#   before_script:
#     - apt-get update && apt-get install -y git unzip libzip-dev
#     - docker-php-ext-install zip
#     - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
#     - cd backend
#     - composer install --prefer-dist --no-interaction --no-progress
#     - composer require --dev phpstan/phpstan
#   script:
#     - cd backend
#     - ./vendor/bin/phpstan analyse app --level=5
#   allow_failure: true

# ===================================================================
# STAGE 3: BUILD - สร้าง Docker Image
# ===================================================================
build-docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  
  before_script:
    # Login to GitLab Container Registry
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  
  script:
    - cd backend
    # Build Docker image
    - docker build -t $DOCKER_IMAGE -t $DOCKER_IMAGE_LATEST .
    
    # Push to registry
    - docker push $DOCKER_IMAGE
    - docker push $DOCKER_IMAGE_LATEST
  
  # รันเฉพาะ main branch
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
    - if: $CI_COMMIT_BRANCH == "develop"
      when: on_success

# ===================================================================
# STAGE 4: DEPLOY - Deploy ไปยัง Server
# ===================================================================

# Deploy to Staging
deploy-staging:
  stage: deploy
  image: alpine:latest
  
  before_script:
    - apk add --no-cache openssh-client
    # เพิ่ม SSH key สำหรับ deploy
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  
  script:
    # SSH ไป staging server แล้ว pull image ใหม่
    - |
      ssh $STAGING_USER@$STAGING_HOST << 'ENDSSH'
        cd /var/www/it-support-pro
        docker-compose pull
        docker-compose up -d
        docker-compose exec -T app php artisan migrate --force
        docker-compose exec -T app php artisan cache:clear
        docker-compose exec -T app php artisan config:cache
        docker-compose exec -T app php artisan route:cache
      ENDSSH
  
  environment:
    name: staging
    url: https://staging.it-support-pro.com
  
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual

# Deploy to Production
deploy-production:
  stage: deploy
  image: alpine:latest
  
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  
  script:
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_HOST << 'ENDSSH'
        cd /var/www/it-support-pro
        docker-compose pull
        docker-compose up -d
        docker-compose exec -T app php artisan migrate --force
        docker-compose exec -T app php artisan cache:clear
        docker-compose exec -T app php artisan config:cache
        docker-compose exec -T app php artisan route:cache
        docker-compose exec -T app php artisan view:cache
      ENDSSH
  
  environment:
    name: production
    url: https://it-support-pro.com
  
  # ต้องกด deploy manual เท่านั้น
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  
  # ต้อง test ผ่านก่อน
  needs:
    - job: test
      artifacts: false